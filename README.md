# Retrosantander

Un experimento personal con el portal del [Centro de Documentaci√≥n de la Imagen de Santander](http://portal.ayto-santander.es/portalcdis/Index.do) (CDIS) y sus contenidos. Por [Jaime G√≥mez-Obreg√≥n](https://twitter.com/JaimeObregon).

[![Retrosantander](/docs/assets/retrosantander.jpg)](https://retrosantander.com)

Prueba de concepto en [üîó retrosantander.com](https://retrosantander.com). Tambi√©n [üé¶ en v√≠deo](/docs/assets/retrosantander.mp4).

# El contexto

El Ayuntamiento de Santander opera el CDIS, una entidad **¬´que tiene como objetivo poner a su disposici√≥n el patrimonio fotogr√°fico municipal¬ª**, seg√∫n su sitio web.

He llamado al CDIS para interesarme por conocer este patrimonio, y me han expresado que el canal para ello es **el mencionado sitio web**. Las visitas al Centro son posibles, pero requieren de una cita previa y especificar con antelaci√≥n sobre qu√© materiales se desea realizar la consulta, para que el equipo t√©cnico del CDIS los prepare con antelaci√≥n.

Puesto que mi inter√©s no es acad√©mico ni historiogr√°fico, sino la mera curiosidad abstracta, me veo con que el portal del CDIS es mi principal interfaz para acceder al patrimonio fotogr√°fico de mi ciudad. Esto no ser√≠a inconveniente de no ser porque **el referido portal es muy mejorable**.

| La portada del CDIS                                | Vista de una imagen                                   | Una exposici√≥n virtual                                                 |
| -------------------------------------------------- | ----------------------------------------------------- | ---------------------------------------------------------------------- |
| ![Portada del CDIS](/docs/assets/cdis-portada.jpg) | ![Una imagen del CDIS](/docs/assets/cdis-detalle.jpg) | ![Detalle de una exposici√≥n virtual](/docs/assets/cdis-exposicion.jpg) |

# Por qu√© el portal del CDIS es muy mejorable

Como santanderino, **el fondo del CDIS me parece un tesoro**. Sin embargo, se pone a disposici√≥n de la ciudadan√≠a de una forma tosca y limitada. Esbozo a continuaci√≥n mis porqu√©s:

## 1. Por el dise√±o del sitio

Un sitio como el del CDIS deber√≠a destinar a la imagen un espacio principal. Las fotograf√≠as deber√≠an presidir el sitio, como presiden los cuadros el sitio web del Museo del Prado. La atenci√≥n del visitante deber√≠a dirigirse **a la contemplaci√≥n de las im√°genes**.

Sin embargo, el sitio web del CDIS relega el tesoro a la √∫ltima de las prioridades. **Las im√°genes parecen un subproducto colateral**, un contenido secundario.

En mi port√°til, las im√°genes del CDIS representan **solo el 3 % de la superficie √∫til** de la pantalla, y en ocasiones por debajo del corte que obliga a hacer desplazamiento vertical.

| La experiencia de b√∫squeda en el CDIS                            | La ficha de una imagen                                  |
| ---------------------------------------------------------------- | ------------------------------------------------------- |
| ![Resultados de la b√∫squeda](/docs/assets/analisis-busqueda.jpg) | ![Ficha de una imagen](/docs/assets/analisis-ficha.jpg) |

Contrapongamos esta equivocada decisi√≥n con la maquetaci√≥n elegida por el Museo del Prado para su sitio web: el museo **pone las obras en el centro de atenci√≥n**. Las exhibe. Se recrea en ellas. Y todo lo dem√°s es accesorio. Queda oculto tras un interfaz de usuario reducido a la m√≠nima expresi√≥n.

![Portada del Museo del Prado](/docs/assets/museo.jpg)

**La navegaci√≥n** por al colecci√≥n fotogr√°fica del CDIS tambi√©n es tediosa. La retah√≠la de defectos y limitaciones es la tristemente habitual en cualquier sitio web promovido por organismos p√∫blicos. La omitir√© aqu√≠, para no hacer este resumen largo y penoso.

## 2. Por las marcas de agua

El CDIS sobreimprime **una enorme marca de agua** sobre las im√°genes que presenta en su sitio web. Lejos de ser un discreto sello, es una monumental firma con las palabras ¬´Centro de Documentaci√≥n de la Imagen de Santander¬ª. Y ocupa de lado a lado el tercio central las im√°genes.

**La marca de agua del CDIS es molesta.** Interfiere con la contemplaci√≥n de las im√°genes, que es la misi√≥n primordial del CDIS, seg√∫n su propio sitio web. En algunos casos, la marca de agua incluso dificulta la identificaci√≥n de elementos esenciales de la escena.

Pero es que esta marca de agua <strong>adem√°s de molesta es tambi√©n ineficaz</strong>, pues es posible eliminarla de cualquier imagen del CDIS, tal y como explico un poco m√°s adelante a efectos √∫nicamente pedag√≥gicos.

| Con marca de agua                                         | Sin marca de agua                                           |
| --------------------------------------------------------- | ----------------------------------------------------------- |
| ![Con marca de agua](/docs/assets/inundacion-marcada.jpg) | ![Sin marca de agua](/docs/assets/inundacion-sin-marca.jpg) |

## 3. Por el modelo de licenciamiento

Si el objetivo declarado es ¬´poner el patrimonio fotogr√°fico municipal a disposici√≥n de¬ª la ciudadan√≠a, ¬øpor qu√© no se hace mediante un licenciamiento abierto y permisivo? Cada vez m√°s organismos p√∫blicos se adhieren a licencias como [Creative Commons](https://creativecommons.org/licenses/?lang=es_ES). **El respeto a los derechos del CDIS y el reconocimiento de los autores de las im√°genes no est√° re√±ido con un modelo de licenciamiento abierto y permisivo.**

El [aviso legal del CDIS](http://portal.ayto-santander.es/portalcdis/InfoLegal.do) es confuso en este sentido. Por una parte, hace una reserva expresa de todos los derechos y prohibe, entre otras cosas, la copia, transmisi√≥n y difusi√≥n no autorizadas. Pero hace una exenci√≥n para un ¬´uso personal¬ª que no concreta:

> Todo material, marcas registradas u otras propiedades intelectuales de este website son propiedad de AYUNTAMIENTO DE SANTANDER o de sus compa√±√≠as afiliadas, y est√°n protegidas por los derechos de autor.
>
> Est√° permitida su reproducci√≥n para uso personal.
>
> Queda prohibida cualquier modificaci√≥n, copia, alquiler, pr√©stamo, trasmisi√≥n y difusi√≥n no autorizada. El material de este website no puede ser vendido ni distribuido de otra forma con √°nimo de lucro.
>
> Todos los derechos Reservados.

![Compra de una imagen](/docs/assets/cdis-compra.jpg)

Por otro lado, sin embargo, el sitio web del CDIS ofrece al ciudadano la compra unitaria de im√°genes, que son entregadas al comprador en un CD (!). Y especifica:

> A trav√©s del portal del CDIS s√≥lo podr√° descargar las im√°genes que desee adquirir para uso privado o p√∫blico sin √°nimo de lucro en media resoluci√≥n (jpg). Para la compra de im√°genes en alta resoluci√≥n (TIFF) o para uso p√∫blico con √°nimo de lucro, p√≥ngase en contacto con el CDIS

Queda claro, por lo tanto, que es preciso comprar las im√°genes para cualquier uso ¬´privado o p√∫blico sin √°nimo de lucro¬ª. Algo que parece chocar con el permiso de reproducci√≥n ¬´para uso personal¬ª del aviso legal, si bien no se define qu√© es un uso ¬´personal¬ª ni en qu√© difiere de un uso ¬´privado¬ª.

## 4. Porque no est√° adaptado a m√≥viles y no es seguro

El portal del CDIS parece datar de 2008. Y aunque por aquel entonces ya eran habituales las tabletas y tel√©fonos, el sitio web no est√° adaptado a estos dispositivos.

| Las exposiciones, desde mi iPhone                                      | La ficha de una im√°gen, desde el m√≥vil                               |
| ---------------------------------------------------------------------- | -------------------------------------------------------------------- |
| ![Las exposiciones, desde el m√≥vil](/docs/assets/movil-exposicion.jpg) | ![Ficha de una imagen, desde el m√≥vil](/docs/assets/movil-ficha.jpg) |

Y aunque el sitio dispone de un certificado y la posibilidad de comunicaciones seguras, no se est√° redireccionando correctamente y el intercambio de informaci√≥n personal del ciudadano con el sitio, por ejemplo para cursar una compra de im√°genes, no se realiza de forma segura. He comprobado que los usuarios que accedan al CDIS desde una b√∫squeda en Google lo hacen por un canal inseguro:

![Aviso de sitio no seguro](/docs/assets/cdis-http.jpg)

# ¬øY por qu√© sucede esto?

En definitiva, el sitio web del CDIS es el principal instrumento de la ciudadan√≠a para acceder al patrimonio fotogr√°fico de la ciudad de Santander, toda vez que las visitas al Centro requieren de concertar una cita previa y especificar por anticipado un inter√©s espec√≠fico, tal y como me han expresado por tel√©fono.

Este sitio web es un desarrollo tosco y aparentemente de 2008, que proporciona al ciudadano un buscador limitado e ineficaz.

Y sin permiso previo no est√° permitido hacer nada con los recursos fotogr√°ficos del CDIS que no sea la mera consulta individual a trav√©s del limitado canal web.

Si el fondo del CDIS es un tesoro de la ciudad, m√°s que ponerse a disposici√≥n de sus habitantes parece estar cogiendo polvo en alguna catacumba.

# El reto

¬øY qu√© puede hacer el ciudadano ante esta praxis de los p√∫blico, de lo que es de todos? ¬øQu√© alternativa hay a la resignaci√≥n frustrante? ¬øPor qu√© no darle una vuelta a todo esto? ¬°Tiene que ser posible poner en valor este tesoro!

La idea‚Ä¶ que es tambi√©n el principal Esta puesta a disposici√≥n se hace fundamentalmente a trav√©s de

# Obteniendo y estructurando la base de datos del CDIS

A t√≠tulo de experimento personal, es posible descargar la base de datos del CDIS y reconstruirla para ponerla en valor con un interfaz de exploraci√≥n alternativo.

Ser√≠a as√≠.

### 1. Descargar todas las p√°ginas de resultados

Nos apalancamos en el filtro de rango temporal para provocar una b√∫squeda que devuelva todo el cat√°logo. Consignamos para ello un filtro entre los a√±os `0` y `2050`, e iteramos por todas las p√°ginas resultantes.

```bash
mkdir pages
curl --output "pages/page_#1.html" \
"http://portal.ayto-santander.es/portalcdis/PrepareBuscadorFotosList.do?"\
"buscadorgeneral=1&"\
"palabraclave=&"\
"fotografo=&"\
"fechainicial=0000&"\
"fechafinal=2050&"\
"goto=[1-793]"
```

### 2. Extraer la direcci√≥n de todas las fichas

Aplicando un `grep` de una expresi√≥n regular a cada una de las p√°ginas de resultados obtenidas en el paso anterior conseguimos la relaci√≥n de todas las fichas de im√°genes del CDIS. Exportamos el conjunto en un fichero de par√°metros con el que alimentaremos `curl` en el paso siguiente.

```bash
grep --no-filename --only-matching \
    'portalcdis/Public/FotoView.do;jsessionid=.\{32\}?id=\d\+' \
    pages/page_*.html \
    | while read line; do \
        echo "url=http://portal.ayto-santander.es/$line"; \
        echo "output=images/image_`echo $line | grep --only-matching "\d\+$"`.html"; \
    done \
    > images.txt
```

### 3. Descargar todas las fichas

Ahora podemos descargar iterativamente todas las fichas del CDIS‚Ä¶

```bash
mkdir images && curl -K images.txt
```

### 4. Extraer la direcci√≥n de todas las im√°genes

‚Ä¶Y obtener de cada una la direcci√≥n URL de su imagen, en dos formatos: con la enorme marca de agua est√°ndar del CDIS, y en ¬´modo exposici√≥n¬ª, que a√±ade una marca mucho m√°s sutil.

```bash
mkdir jpeg
ORIGIN=http://portal.ayto-santander.es
grep --no-filename --only-matching \
    'portalcdis/image/DownloadFile.do?id=\d\+' \
    images/image_*.html \
    | while read line; do \
        ID=`echo $line | grep --only-matching "\d\+$"`
        echo "url=$ORIGIN/$line"; \
        echo "output=jpeg/${ID}_a.jpeg"; \
        echo "url=$ORIGIN/`echo $line | sed 's/DownloadFile/DownloadFileExposicion/'`"; \
        echo "output=jpeg/${ID}_b.jpeg"; \
    done > jpeg.txt
```

### 5. Descargar todas las fotos

La descarga de las im√°genes se hace con cURL, introduciendo la sucesi√≥n de URL y ficheros de salida con el fichero de texto creado en al paso anterior.

```bash
mkdir jpeg && curl -K jpeg.txt
```

### 6. Interpretar las fichas y crear el repositorio JSON

He escrito un int√©rprete, [`parser.php`](private/parser.php), que mediante expresiones regulares procesa las p√°ginas HTML del CDIS y devuelve los resultados estructurados. Pasamos su salida a `jq` para obtener la base de datos reconstruida en [`retrosantander.json`](httpdocs/retrosantander.json).

```bash
for file in images/image_*.html;
    do cat $file | php parser.php; done \
| jq --slurp > retrosantander.json
```

### 7. Eliminar la marca de agua

Obtenidas dos versiones de cada imagen, cada una con una marca de agua diferente, es posible combinarlas en una tercera sin marca de agua alguna. Un m√©todo para ello es recortar el 10 % inferior de la primera versi√≥n con el 90 % superior de la segunda y unir ambos recortes. Esto se puede automatizar para todo el fondo del CDIS.

![Eliminaci√≥n de la marca de agua](/docs/assets/marca-de-agua.gif)

```bash
mkdir merged
for id in `jq --raw-output '.[].id' retrosantander.json`; do
    convert \
        jpeg/${id}_b.jpeg \
        \( jpeg/${id}_a.jpeg -gravity south -crop 0x10%+0+0 \) \
        -composite merged/${id}.jpeg;
done
```
